- name: Deploy VMs on vSphere
  vmware_guest: "{{ vm }}"
  async: "{{ async_timeout }}"
  poll: 0
  ignore_errors: "{{ ignore_errors }}"
  loop: "{{ batch }}"
  loop_control:
    loop_var: "vm"
  register: deployed_vms

- name: Check sync status
  async_status:
    jid: "{{ async_result_item.ansible_job_id }}"
  loop: "{{ deployed_vms.results }}"
  loop_control:
    loop_var: "async_result_item"
  register: async_poll_results
  until: async_poll_results is finished
  retries: "{{ retries}}"
  delay: "{{ delay }}"

- name: Display deployed VMs parameters
  debug:
    msg: "{{ deployed_vms }}"
  when: debug == True
